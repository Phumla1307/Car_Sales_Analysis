---Data Cleaning & Staging Step
--Checking and eliminating empty spaces for each column and replacing them by a null or empty space 

with base AS 
(
    SELECT year, 
    
    make,  
    case 
        when make is null or trim(make) = '' then 'Unknown'
        else initcap(make) 
    end as car_make,
    
    model,
    case 
        when model is null or trim(model) = '' then 'Unknown'
        else initcap(model)
    end as model_type, 
        
    body, 
    case
        when body is null or trim(body) = '' then 'Unknown'
        else initcap(body)
     end as body_type, 
    
    transmission,
    case
        when transmission is NULL or trim(transmission) =  '' then 'Unknown'
        else initcap(transmission)
     end as transmission_cleaned,
        
    state,

/*
Audit Distinct States and write out the full state name to avoid ambiguity 
select distinct state  FROM "SNOWFLAKE_LEARNING_DB"."PUBLIC"."CAR_SALES"
order by state;
*/
    
        case
            when state is null or trim(state) = '' then 'unknown'
            when length(state) = 17 and regexp_like(state, '^[A-Z0-9]+$') then 'Unknown'
            when upper(state) = 'AB' then 'Alberta'
            when upper(state) = 'AL' then 'Alabama'
            when upper(state) = 'AZ' then 'Arizona'
            when upper(state) = 'CA' then 'California'
            when upper(state) = 'CO' then 'Colorado'
            when upper(state) = 'FL' then 'Florida'
            when upper(state) = 'GA' then 'Georgia'
            when upper(state) = 'HI' then 'Hawaii'
            when upper(state) = 'IL' then 'Illinois'
            when upper(state) = 'IN' then 'Indiana'
            when upper(state) = 'LA' then 'Louisiana'
            when upper(state) = 'MA' then 'Massachusetts'
            when upper(state) = 'MD' then 'Maryland'
            when upper(state) = 'MI' then 'Michigan'
            when upper(state) = 'MN' then 'Minnesota'
            when upper(state) = 'MO' then 'Missouri'
            when upper(state) = 'MS' then 'Mississippi'
            when upper(state) = 'NC' then 'North Carolina'
            when upper(state) = 'NE' then 'Nebraska'
            when upper(state) = 'NJ' then 'New Jersey'
            when upper(state) = 'NM' then 'New Mexico'
            when upper(state) = 'NS' then 'Nova Scotia'
            when upper(state) = 'NV' then 'Nevada'
            when upper(state) = 'NY' then 'New York'
            when upper(state) = 'OH' then 'ohio'
            when upper(state) = 'OK' then 'Oklahoma'
            when upper(state) = 'ON' then 'Ontario'
            when upper(state) = 'OR' then 'Oregon'
            when upper(state) = 'PA' then 'Pennyslvania'
            when upper(state) = 'PR' then 'Puerto Rico'
            when upper(state) = 'QC' then 'Quebec'
            when upper(state) = 'SC' then 'South Carolina'
            when upper(state) = 'TN' then 'Tennessee'
            when upper(state) = 'TX' then 'Texas'
            when upper(state) = 'UT' then 'Utah'
            when upper(state) = 'VA' then 'Virgina'
            when upper(state) = 'WA' then 'Washington'
            when upper(state) = 'WI' then 'Wisconsin'
            else initcap(state)
        end as state_name,

        color,
/* 
--Check Distinct Values 
select DISTINCT color from "SNOWFLAKE_LEARNING_DB"."PUBLIC"."CAR_SALES"
Order By color DESC;
*/

        case 
            when color is null or trim(color) = '' then 'Unknown'
            when color = '—' then 'Unknown'
            when regexp_like(color,'^[0-9]+$') then 'Unknown'
            else initcap(color)
        end as car_color,
        

/*
Check the Distinct interior and empty cells
select DISTINCT interior from "SNOWFLAKE_LEARNING_DB"."PUBLIC"."CAR_SALES"
Order By interior DESC;
*/

    interior,

        case
            when interior is null or trim(interior) = '' then 'Unknown'
            when interior = '—' then 'Unknown'
            else initcap(interior)
        end as car_interior,
    


        initcap(seller) as seller_name,

/*
Check the number of seller | 14263
select count(distinct seller) as distinct_sellers from "SNOWFLAKE_LEARNING_DB"."PUBLIC"."CAR_SALES"
*/


    --Grouping Conditions based on rating 
        condition,
       
        case
            when condition between 1 and 19 then 'Very Poor Condition'
            when condition between 20 and 29 then 'Poor Condition'
            when condition between 30 and 39 then 'Average Condition'
            when condition between 40 and 49 then 'Good Condition'
            else 'Excellent Condition'
        end as Condition_State, 
    
    /*
    
    Check Odometer Range 
    select max(odometer) as max_odometer, min(odometer) as min_odometer from "SNOWFLAKE_LEARNING_DB"."PUBLIC"."CAR_SALES"
    
    */
    
        odometer,
        case 
            when odometer between 1 and 19999 then 'Low Mileage'
            when odometer between  20000 and 59999 then 'Moderate Mileage'
            when odometer between 60000 and 119999 then 'High Mileage'
            when odometer between 120000 and 199999 then 'Very High Mileage'
            else 'Extreme Mileage'
        end as Odometer_Category, 
    
    --Profit Margins 
        mmr, sellingprice, 
        (((sellingprice - mmr) / sellingprice) * 100) as avg_profit_margin,
/*   
   
    SaleDate Parsing 
    check dates that are not the right format
    select saledate from "SNOWFLAKE_LEARNING_DB"."PUBLIC"."CAR_SALES"
    where regexp_like(saledate,'^[0-9]+$')
    limit 100;

*/

    
        try_to_timestamp(left(saledate,24), 'DY MON DD YYYY HH24:MI:SS') as sale_stamp,
        dayname(try_to_timestamp(left(saledate,24),'DY MON DD YYYY HH24:MI:SS' )) as sale_day,
        monthname(try_to_timestamp(left(saledate,24),'DY MON DD YYYY HH24:MI:SS')) as sale_month,
        year(try_to_timestamp(left(saledate,24),'DY MON DD YYYY HH24:MI:SS')) as sale_year,  
/*
        extract(hour from try_to_timestamp(left(saledate,24), 'DY MON DD YYYY HH24:MI:SS')) as sale_hour,
        extract(minute from try_to_timestamp(left(saledate,24), 'DY MON DD YYYY HH24:MI:SS')) as sale_minute

*/
    FROM
      "SNOWFLAKE_LEARNING_DB"."PUBLIC"."CAR_SALES"
    where not regexp_like(saledate,'^[0-9]+$')
)


/*

--Data Analysis
select seller_name,
    count(*) as cars_sold, 
    avg(avg_profit_margin) as avg_margin
from base
group by seller_name
order by avg_margin DESC;

*/

select 
    year,
    make, 
    model_type, 
    body_type,
    transmission_cleaned,
    state_name,
    car_color,
    car_interior, 
    seller_name,
    condition,
    Condition_State,
    odometer,
    Odometer_Category,
    mmr,
    sellingprice,
    avg_profit_margin,

    Case
        when avg_profit_margin < 0 then 'Loss'
        when avg_profit_margin between 0 and 10 then 'Low Margin'
        when avg_profit_margin between 10 and 25 then 'Moderate Margin'
        else 'High Margin'
    end as profit_category, 

  sale_stamp,
  sale_day,
  sale_month, 
  sale_year,

    case
        when sale_day in ('Saturday', 'Sunday') then 'Weekend'
        else 'Weekday'
    end as day_type,
 
From base;





    
